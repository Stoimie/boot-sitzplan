<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Sitzplan Boot - Final V1.0</title>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

    <style>
        /* --- GRUNDGER√úST --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
            background-color: #333;
            overflow: hidden;
        }

        /* --- LINKE SEITE: G√ÑSTELISTE --- */
        #guest-sidebar {
            width: 300px;
            min-width: 300px;
            background: #fff;
            padding: 20px;
            overflow-y: auto;
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }

        h3 { margin-top: 0; margin-bottom: 10px; color: #333; }
        .hint { font-size: 11px; color: #666; margin-bottom: 10px; }

        /* --- STATISTIK BOX --- */
        #stats-box {
            background: #e3f2fd;
            color: #0d47a1;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 15px;
            border: 1px solid #bbdefb;
        }

        /* --- SUCHE --- */
        #search-box {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        /* --- DESIGN DER G√ÑSTE-KARTE (LISTE) --- */
        .guest-item {
            background-color: #f5f5f5; 
            color: #333;
            padding: 6px 8px; 
            margin-bottom: 4px;
            cursor: grab;
            border-radius: 4px;
            font-size: 12px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border-left: 5px solid #999; 
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.2;
            transition: all 0.2s;
        }
        
        .guest-item:active { cursor: grabbing; }

        .guest-name-text { font-weight: bold; }
        
        .guest-company-text {
            font-size: 10px;
            color: #666;
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- FARBEN F√úR FIRMEN --- */
        .guest-item.company-aon { border-left-color: #d32f2f; background-color: #ffebee; }
        .guest-item.company-other { border-left-color: #1976d2; background-color: #e3f2fd; }

        /* --- RECHTE SEITE: SCROLL-BEREICH --- */
        #boat-scroll-container {
            flex-grow: 1;
            overflow: auto;
            background-color: #e0e0e0;
            padding: 20px;
            
            /* WICHTIG: Kein Flexbox mehr! */
            display: block; 
            
            /* Das ist der Ersatz f√ºr justify-center: */
            text-align: center; 
        }

        /* --- DER ROCK-SOLID WRAPPER (V3.0) --- */
        #map-wrapper {
            position: relative;
            
            /* HIER IST DER SCHL√úSSEL: */
            /* Der Rahmen selbst bekommt die Bremse! */
            max-width: 1200px; 
            
            /* Er nimmt sich den Platz, den er braucht (bis 1200px) */
            width: 100%;
            
            /* Zentriert den Rahmen auf dem Bildschirm */
            margin: 0 auto;
            
            /* Verhindert Grafikfehler */
            line-height: 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        #plan-image {
            /* Das Bild ist jetzt "dumm" und f√ºllt einfach den Rahmen aus */
            width: 100%; 
            height: auto; 
            display: block;
        }
        
        /* Sicherheits-Regel f√ºr alle Elemente */
        * { box-sizing: border-box; }
        
        /* WICHTIG: Damit Prozentrechnung √ºberall gleich funktioniert */
        * { box-sizing: border-box; }

        /* --- DIE TISCHE --- */
        .table {
            position: absolute;
            width: 6.5%;          
            aspect-ratio: 1 / 1;  
            height: auto;         
            background-color: transparent;
            border: none;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            overflow: hidden; 
            transition: all 0.2s ease-in-out;
            transform: translate(-50%, -50%);
        }

        /* --- HOVER EFFEKT (ZOOM) --- */
        .table:hover {
            transform: scale(2.5);
            z-index: 1000;
            background-color: white; 
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            aspect-ratio: auto;
            height: auto;
            min-height: 100px;
            border: 1px solid #999;
        }

        .seat-container {
            width: 95%;
            height: 85%;
            overflow-y: auto;
            scrollbar-width: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .seat-container::-webkit-scrollbar { display: none; }

        /* --- GAST AUF DEM TISCH --- */
        .guest-on-table {
            display: none; 
            
            /* HIER GE√ÑNDERT: Jetzt 6px (noch kleiner) */
            font-size: 6px; 
            font-weight: normal; 

            background: #fff;
            color: #333;
            margin: 1px 0;
            
            /* Padding reduziert f√ºr kompakten Look */
            padding: 1px 3px; 
            /* Das zentriert den Text vertikal etwas besser: */
            line-height: 1.2;

            border-radius: 3px;
            border: 1px solid #ccc;
            cursor: pointer;
            text-align: center;
            width: 92%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-left: 3px solid #999; 
        }

        /* --- NEU: FIRMA IM TISCH EXTRA KLEIN --- */
        .guest-on-table .guest-company-text {
            font-size: 5px;  /* Kleiner als der Name (6px) */
            line-height: 2;  /* Zeilenabstand verringern */
            opacity: 0.8;    /* Etwas blasser machen */
            margin-top: 0;   /* Abstand zum Namen wegnehmen */
        }

        .guest-on-table.company-aon { border-left-color: #d32f2f; }
        .guest-on-table.company-other { border-left-color: #1976d2; }

        .table:hover .guest-on-table { display: block; }

        .guest-on-table:hover {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid red;
        }

        /* --- TEXTE IM TISCH --- */
        .table-title {
            display: none;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: #d32f2f;
            border-bottom: 1px solid #eee;
            margin-bottom: 3px;
        }
        .table:hover .table-title { 
            display: block; 
            font-size: 7px; 
            padding-top: 3px; 
        }

        .seat-counter {
            position: absolute;
            top: 75%;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.9);
            pointer-events: none;
        }
        .table:hover .seat-counter { display: none; }

        /* --- POSITIONIERUNG --- */
        #t12 { top: 21.3%; left: 27%; }
        #t10 { top: 33.8%; left: 27%; }
        #t6  { top: 42.5%; left: 27%; }
        #t4  { top: 54.2%; left: 27%; }
        #t1  { top: 61.5%; left: 27%; }

        #t11 { top: 26.6%; left: 31.5%; }
        #t9  { top: 35.6%; left: 39.2%; }
        #t7  { top: 42.5%; left: 39.2%; }
        #t5  { top: 54.2%; left: 39.2%; }
        #t2  { top: 61.5%; left: 39.2%; }

        #t8  { top: 38.9%; left: 51.4%; }
        #t3  { top: 57.8%; left: 51.4%; }

        /* --- DRUCK-ANSICHT --- */
        #print-area { display: none; }

        @media print {
            #guest-sidebar, #boat-scroll-container, button { display: none !important; }
            body { background-color: white; height: auto; overflow: visible; display: block; }
            #print-area { display: block; padding: 40px; font-family: Arial, sans-serif; }
            .print-table-block { margin-bottom: 20px; page-break-inside: avoid; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
            .print-table-title { font-size: 16px; font-weight: bold; color: #d32f2f; margin-bottom: 5px; border-bottom: 2px solid #d32f2f; }
            .print-guest-row { font-size: 12px; padding: 3px 0; border-bottom: 1px solid #eee; }
            .print-guest-company { color: #666; font-style: italic; font-size: 10px; margin-left: 10px; }
        }

        /* --- TEMPOR√ÑRE HILFSLINIEN (zu Ausrichten der Tische) --- */
        /* .table {
        border: 2px solid red !important;
        background-color: rgba(255, 0, 0, 0.3);
        z-index: 9999;
        }
        */

        /* --- 1. DIE "PLOPP" ANIMATION --- */
        @keyframes plopp {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); }  /* Geht kurz √ºber die Gr√∂√üe hinaus */
            100% { transform: scale(1); opacity: 1; }
        }

        /* Wir wenden die Animation an, sobald ein Gast die Klasse erh√§lt */
        .guest-on-table {
            animation: plopp 0.4s ease-out forwards;
        }

        /* --- 2. DER "GLASSMORPHISMUS" F√úR OFFENE TISCHE --- */
        /* Das ersetzt den einfachen wei√üen Hintergrund beim Hover */
        .table:hover {
            background-color: rgba(255, 255, 255, 0.85) !important; /* Leicht durchsichtig */
            backdrop-filter: blur(8px); /* Der Milchglas-Effekt (Weichzeichner dahinter) */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important; /* Weicherer Schatten */
            border: 1px solid rgba(255, 255, 255, 0.5) !important; /* Zarter wei√üer Rand */
        }

        /* --- 3. DER "FERTIG"-STATUS (GR√úNES LEUCHTEN) --- */
        /* Diese Klasse f√ºgen wir gleich per Javascript hinzu */
        /* --- DER "FERTIG"-STATUS (JETZT ROT) --- */
        .table-full {
            /* Ein rotes Leuchten (Warnung: Voll!) */
            box-shadow: 0 0 15px #d32f2f, inset 0 0 10px #d32f2f !important; 
            border: 2px solid #d32f2f !important;
            
            /* Roter Hintergrund-Schimmer */
            background-color: rgba(211, 47, 47, 0.25) !important; 
            
            transition: all 0.5s ease; /* Sanfter √úbergang */
        }
        
        /* Damit die Schrift auf dem roten Kreis gut lesbar bleibt */
        .table-full .seat-counter {
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            font-weight: 900;
        }

        /* --- MODERNE BUTTONS --- */
        .modern-btn {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 12px;
            border: none;
            border-radius: 50px; /* "Pill"-Shape f√ºr modernen Look */
            
            font-size: 13px;
            font-weight: bold;
            color: white;
            text-transform: uppercase; /* Alles Gro√übuchstaben wirkt aufger√§umter */
            letter-spacing: 0.5px;
            
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); /* Weicher Schatten */
            transition: all 0.3s ease; /* Sanfte Animation */
            
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* Abstand zwischen Icon und Text */
        }

        /* Hover-Effekt: Button schwebt hoch */
        .modern-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* Klick-Effekt: Button dr√ºckt sich rein */
        .modern-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* --- DIE FARB-VARIANTEN (Verl√§ufe) --- */
        
        /* Blau/Lila f√ºr Drucken */
        .btn-print {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Frisches Gr√ºn f√ºr Excel */
        .btn-excel {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        /* Warnendes Rot/Orange f√ºr L√∂schen */
        .btn-reset {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        /* --- KONTEXT-MEN√ú DESIGN --- */
        .context-menu {
            display: none;
            position: absolute;
            z-index: 10000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 6px 0;
            min-width: 180px;
            border: 1px solid #ddd;
            font-size: 13px;
            color: #333;
        }
        .menu-item { padding: 8px 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .menu-item:hover { background-color: #f5f5f5; }
        .menu-item.delete:hover { background-color: #ffebee; color: #d32f2f; }
        .menu-divider { height: 1px; background-color: #eee; margin: 4px 0; }

        /* --- GESPERRTER TISCH (GRAU & SCHLOSS) --- */
        .table.locked {
            border: 2px dashed #999 !important; /* Gestrichelter Rand */
            background-color: rgba(220, 220, 220, 0.3) !important; /* Leicht ausgegraut */
        }
        
        /* Das Schloss-Icon am Tischrand */
        .table.locked::after {
            content: 'üîí';
            position: absolute;
            top: 0px;
            right: 0px;
            font-size: 12px;
            background: white;
            border-radius: 50%;
            padding: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            pointer-events: none;
        }

        /* Inhalt verblasst etwas, wenn gesperrt */
        .table.locked .seat-container {
            opacity: 0.6;
            pointer-events: none; /* Verhindert Klicks auf die G√§ste */
        }

        /* --- DRAG & DROP HIGHLIGHTING --- */
        
        /* 1. Ein g√ºltiges Ziel (Freier Tisch) */
        .drop-valid {
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.8) !important; /* Kr√§ftiges gr√ºnes Leuchten */
            border: 2px solid #4caf50 !important;
            background-color: rgba(76, 175, 80, 0.15) !important;
            transform: translate(-50%, -50%) scale(1.05) !important; /* Wird leicht gr√∂√üer */
            z-index: 500;
        }

        /* 2. Ein ung√ºltiges Ziel (Voll oder Gesperrt) */
        .drop-invalid {
            opacity: 0.3 !important; /* Wird durchsichtig/unwichtig */
            filter: grayscale(100%) !important; /* Verliert die Farbe */
            pointer-events: none;
        }

        /* 3. Der Pool (Sicherer Hafen) */
        .pool-valid {
            box-shadow: inset 0 0 15px rgba(33, 150, 243, 0.5) !important;
            border: 2px dashed #2196f3 !important;
            background-color: #e3f2fd !important;
        }

        /* --- SUCH-ERGEBNISSE AUF DER KARTE --- */
        
        /* 1. Der gefundene Tisch (Goldenes Pulsieren) */
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .search-match-table {
            animation: pulse-gold 1.5s infinite; /* Herzschlag-Effekt */
            border: 3px solid #ffc107 !important; /* Goldener Rand */
            z-index: 100 !important; /* In den Vordergrund */
            background-color: rgba(255, 255, 255, 0.9) !important; /* Hell machen */
        }

        /* 2. Der gefundene Name IM Tisch */
        .search-match-guest {
            background-color: #fff9c4 !important; /* Helles Gelb */
            color: #000 !important;
            border: 1px solid #fbc02d !important;
            font-weight: bold;
        }

        /* 3. Alles andere abdunkeln (Focus-Modus) */
        /* Wir geben dem Body eine Klasse 'searching', dann werden nicht-betroffene Tische blass */
        body.searching .table:not(.search-match-table) {
            opacity: 0.3;
            filter: grayscale(80%);
            transition: opacity 0.3s;
        }

        /* --- ERWEITERTE STATISTIK --- */
        #stats-box {
            background: #e3f2fd; /* Ein helles Dashboard-Blau */
            border: 1px solid #bbdefb;
            color: #333;
            padding: 12px;
            font-size: 13px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            line-height: 1.6;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 4px;
            margin-bottom: 4px;
        }
        .stat-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .stat-label { font-weight: normal; color: #555; }
        .stat-value { font-weight: bold; color: #000; }
        
        /* Highlight f√ºr "Voll" */
        .stat-sub { font-size: 11px; color: #666; margin-top: 5px; }

        /* --- ORANGE WARN-BUTTON --- */
        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            box-shadow: 0 4px 15px rgba(245, 124, 0, 0.3);
        }
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 124, 0, 0.4);
        }
        
    </style>
</head>
<body>

    <div id="print-area">
        <h1>Sitzplan √úbersicht</h1>
        <div id="print-content"></div>
    </div>

    <div id="guest-sidebar">
        <h3>G√§steliste</h3>
        
        <div id="stats-box">Lade Daten...</div>

       

        <input type="text" id="search-box" placeholder="üîç Namen suchen...">
        <p class="hint">Ziehe Namen auf die Tische.</p>
        
        <div id="guest-pool"></div>

        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            
            <button onclick="printList()" class="modern-btn btn-print">
                <span>üñ®Ô∏è</span> Drucken (PDF)
            </button>
            
            <button id="export-excel-btn" class="modern-btn btn-excel">
                <span>üíæ</span> Excel Export
            </button>

            <button class="modern-btn btn-warning" id="clear-tables-btn" style="margin-bottom: 10px;">
                üßπ Tische leeren
            </button>

            <button id="reset-btn" class="modern-btn btn-reset">
                <span>üóëÔ∏è</span> Alles L√∂schen
            </button>

            
        </div>

         <div style="margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 15px;">
            <p class="hint">Excel-Upload (.xlsx)<br>Spalten: <b>Vorname, Name, Firma</b></p>
            <input type="file" id="excel-upload" accept=".xlsx, .xls" style="font-size: 11px; width: 100%;">
            
            
        </div>
    </div>

    <div id="boat-scroll-container">
        <div id="map-wrapper">
            <img src="plan.png" id="plan-image" alt="Bootsplan">

            <div class="table" id="t12" data-max="10"><div class="table-title">Tisch 12</div><div class="seat-counter">0/10</div><div class="seat-container"></div></div>
            <div class="table" id="t11" data-max="10"><div class="table-title">Tisch 11</div><div class="seat-counter">0/10</div><div class="seat-container"></div></div>
            <div class="table" id="t10" data-max="8"><div class="table-title">Tisch 10</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t9" data-max="8"><div class="table-title">Tisch 9</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t8" data-max="8"><div class="table-title">Tisch 8</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t6" data-max="8"><div class="table-title">Tisch 6</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t7" data-max="8"><div class="table-title">Tisch 7</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t4" data-max="8"><div class="table-title">Tisch 4</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t5" data-max="8"><div class="table-title">Tisch 5</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t3" data-max="8"><div class="table-title">Tisch 3</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t1" data-max="8"><div class="table-title">Tisch 1</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
            <div class="table" id="t2" data-max="8"><div class="table-title">Tisch 2</div><div class="seat-counter">0/8</div><div class="seat-container"></div></div>
        </div>
    </div>

    <div id="context-menu" class="context-menu">
        <div id="guest-options">
            <div class="menu-item" id="ctx-edit-name">‚úèÔ∏è Namen bearbeiten</div>
            <div class="menu-item" id="ctx-edit-company">üè¢ Firma √§ndern</div>
            <div class="menu-divider"></div>
            <div class="menu-item delete" id="ctx-remove">‚ùå Vom Tisch nehmen</div>
            <div class="menu-divider"></div>
        </div>
        
        <div class="menu-item" id="ctx-lock-toggle">üîí Tisch sperren</div>
    </div>

    <script>
        const pool = document.getElementById('guest-pool');
        const containers = document.querySelectorAll('.seat-container, #guest-pool');
        const STORAGE_KEY = 'boot_sitzplan_data_v2';

        window.addEventListener('load', () => {
            if (!loadState()) updateCounters();
        });

        /* --- DIE SUPER-SUCHE (Liste + Karte) --- */
        document.getElementById('search-box').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            const poolItems = document.querySelectorAll('#guest-pool .guest-item');
            const mapGuests = document.querySelectorAll('.guest-on-table');
            const tables = document.querySelectorAll('.table');

            // 1. Zuerst alles aufr√§umen (alte Highlights entfernen)
            document.body.classList.remove('searching');
            tables.forEach(t => t.classList.remove('search-match-table'));
            mapGuests.forEach(g => g.classList.remove('search-match-guest'));

            // Wenn Suchfeld leer ist -> Abbruch, alles wieder normal zeigen
            if (term === "") {
                poolItems.forEach(item => item.style.display = 'flex');
                return;
            }

            // Wir sind im Such-Modus -> Body markieren (f√ºr den Dimming-Effekt)
            document.body.classList.add('searching');

            // 2. Linke Liste filtern (wie fr√ºher)
            poolItems.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                const company = item.getAttribute('data-company').toLowerCase();
                if (name.includes(term) || company.includes(term)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // 3. Auf der Karte suchen (NEU!)
            let foundOnMap = false;
            mapGuests.forEach(guest => {
                const name = guest.getAttribute('data-name').toLowerCase();
                const company = guest.getAttribute('data-company').toLowerCase();
                
                if (name.includes(term) || company.includes(term)) {
                    // Treffer!
                    foundOnMap = true;
                    
                    // Gast markieren
                    guest.classList.add('search-match-guest');
                    
                    // Den zugeh√∂rigen Tisch finden und markieren
                    const parentTable = guest.closest('.table');
                    if (parentTable) {
                        parentTable.classList.add('search-match-table');
                    }
                }
            });
        });

        function getCompanyClass(company) {
            if (!company) return 'company-other';
            if (company.toLowerCase().includes('aon')) return 'company-aon';
            return 'company-other';
        }

     // 3. DRUCKEN (Jetzt mit Sortierung!)
        window.printList = function() {
            const content = document.getElementById('print-content');
            content.innerHTML = ''; // Leeren

            // 1. Alle Tische in eine echte Liste (Array) umwandeln
            const tables = Array.from(document.querySelectorAll('.table'));

            // 2. Die Liste sortieren
            tables.sort((a, b) => {
                // Wir holen den Text (z.B. "Tisch 12")
                const textA = a.querySelector('.table-title').innerText;
                const textB = b.querySelector('.table-title').innerText;
                
                // Wir filtern nur die Zahlen heraus (aus "Tisch 12" wird 12)
                const numA = parseInt(textA.replace(/\D/g, ''));
                const numB = parseInt(textB.replace(/\D/g, ''));

                // Vergleichen: Ist A kleiner als B?
                return numA - numB;
            });

            // 3. Die sortierte Liste durchgehen und drucken
            tables.forEach(table => {
                const title = table.querySelector('.table-title').innerText;
                const guests = table.querySelectorAll('.guest-on-table');
                
                // Nur drucken, wenn auch wer sitzt
                if (guests.length > 0) {
                    let html = `<div class="print-table-block"><div class="print-table-title">${title} (${guests.length} Pers.)</div>`;
                    
                    guests.forEach(g => {
                        // Daten holen
                        const name = g.getAttribute('data-name');
                        const company = g.getAttribute('data-company');
                        
                        html += `<div class="print-guest-row">
                                    <b>${name}</b> 
                                    <span class="print-guest-company">${company}</span>
                                 </div>`;
                    });
                    
                    html += `</div>`;
                    content.innerHTML += html;
                }
            });
            
            // Druck-Dialog √∂ffnen
            window.print();
        }

        document.getElementById('excel-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                pool.innerHTML = '';
                document.querySelectorAll('.seat-container').forEach(el => el.innerHTML = '');

                jsonData.forEach((row, index) => {
                    const vorname = row['Vorname'] || '';
                    const nachname = row['Name'] || ''; 
                    const firma = row['Firma'] || ''; 
                    const fullName = `${vorname} ${nachname}`.trim();

                    if (fullName.length > 0) {
                        createGuestElement(index + 1, fullName, firma, true);
                    }
                });
                updateCounters();
                saveState();
            };
            reader.readAsArrayBuffer(file);
        });

        function createGuestElement(idSuffix, name, company, appendToPool = true) {
            const div = document.createElement('div');
            div.classList.add('guest-item');
            div.classList.add(getCompanyClass(company));
            div.setAttribute('draggable', 'true');
            div.id = 'g_import_' + idSuffix;
            div.setAttribute('data-name', name);
            div.setAttribute('data-company', company);

            let htmlContent = `<div class="guest-name-text">${name}</div>`;
            if (company) htmlContent += `<div class="guest-company-text">${company}</div>`;
            div.innerHTML = htmlContent;

            // --- START DES ZIEHENS (Licht an!) ---
            div.addEventListener('dragstart', () => { 
                div.classList.add('dragging'); 
                
                // 1. Alle Tische pr√ºfen
                document.querySelectorAll('.table').forEach(table => {
                    const isLocked = table.classList.contains('locked');
                    const isFull = table.classList.contains('table-full');
                    
                    // Wenn Tisch offen UND nicht voll -> Gr√ºn leuchten
                    if (!isLocked && !isFull) {
                        table.classList.add('drop-valid');
                    } else {
                        // Sonst -> Ausgrauen
                        table.classList.add('drop-invalid');
                    }
                });

                // 2. Pool auch beleuchten (als R√ºckzugsort)
                document.getElementById('guest-pool').classList.add('pool-valid');
            });

            // --- ENDE DES ZIEHENS (Licht aus!) ---
            div.addEventListener('dragend', () => { 
                div.classList.remove('dragging'); 
                
                // Alle Spezial-Klassen wieder entfernen
                document.querySelectorAll('.table').forEach(table => {
                    table.classList.remove('drop-valid', 'drop-invalid');
                });
                document.getElementById('guest-pool').classList.remove('pool-valid');

                handleDragEnd(div);
            });

            if (appendToPool) pool.appendChild(div);
            return div;
        }

        function handleDragEnd(draggable) {
            if (draggable.parentElement.classList.contains('seat-container')) {
                draggable.classList.add('guest-on-table');
                draggable.classList.remove('guest-item');
                draggable.style.display = ''; 
            } else {
                draggable.classList.remove('guest-on-table');
                draggable.classList.add('guest-item');
                draggable.style.display = 'flex'; 
            }
            updateCounters();
            saveState();
        }

        containers.forEach(container => {
            container.addEventListener('dragover', e => {

                // --- NEU: STOPP BEI GESPERRTEN TISCHEN ---
                if (container.parentElement.classList.contains('locked')) return;
                // ------------------------------------------

                if (container.id === 'guest-pool') {
                    e.preventDefault();
                    const draggable = document.querySelector('.dragging');
                    if(draggable) container.appendChild(draggable);
                    return;
                }
                const table = container.parentElement;
                const maxSeats = parseInt(table.getAttribute('data-max'));
                const currentGuests = container.children.length;
                if (currentGuests < maxSeats) {
                    e.preventDefault();
                    const draggable = document.querySelector('.dragging');
                    if(draggable) container.appendChild(draggable);
                }
            });
        });

        /* --- HAUPT-LOGIK: MEN√ú & SPERREN --- */
        const contextMenu = document.getElementById('context-menu');
        const guestOptions = document.getElementById('guest-options');
        const lockBtn = document.getElementById('ctx-lock-toggle');
        
        let currentContextObj = null; // Speichert, worauf wir geklickt haben

        // 1. RECHTSKLICK (√ñffnet Men√º)
        document.addEventListener('contextmenu', (e) => {
            const table = e.target.closest('.table');
            const guest = e.target.closest('.guest-on-table');
            
            // Men√º nur zeigen, wenn wir auf einem Tisch sind
            if (table) {
                e.preventDefault();
                contextMenu.style.top = `${e.pageY}px`;
                contextMenu.style.left = `${e.pageX}px`;
                contextMenu.style.display = 'block';

                currentContextObj = { table: table, guest: guest };
                const isLocked = table.classList.contains('locked');

                // Men√º anpassen: Ist der Tisch gesperrt?
                if (isLocked) {
                    lockBtn.innerText = "üîì Tisch entsperren";
                    if(guestOptions) guestOptions.style.display = 'none'; // Keine Bearbeitung m√∂glich
                } else {
                    lockBtn.innerText = "üîí Tisch sperren";
                    // Gast-Optionen nur zeigen, wenn wir auch einen Gast getroffen haben
                    if(guestOptions) guestOptions.style.display = guest ? 'block' : 'none';
                }
            } else {
                contextMenu.style.display = 'none';
            }
        });

        // 2. LINKSKLICK (Schlie√üen & Turbo-L√∂schen)
        document.addEventListener('click', (e) => {
            // Men√º schlie√üen
            if (contextMenu.style.display === 'block') {
                contextMenu.style.display = 'none';
                return;
            }

            // Turbo-L√∂schen (Nur wenn Tisch NICHT gesperrt)
            const target = e.target.closest('.guest-on-table');
            if (target) {
                const parentTable = target.closest('.table');
                
                // WICHTIG: Wenn gesperrt -> Nichts tun!
                if (parentTable && parentTable.classList.contains('locked')) return;

                // Sonst: Rauswerfen
                pool.appendChild(target);
                target.classList.remove('guest-on-table');
                target.classList.add('guest-item');
                target.style.display = 'flex'; 
                updateCounters();
                saveState();
            }
        });

        // 3. MEN√ú-AKTIONEN
        
        // Sperren / Entsperren
        if(lockBtn) {
            lockBtn.addEventListener('click', () => {
                if (currentContextObj && currentContextObj.table) {
                    currentContextObj.table.classList.toggle('locked');
                    saveState();
                }
            });
        }

        // Entfernen (Korrigiert: Macht die Arbeit direkt selbst)
        document.getElementById('ctx-remove').addEventListener('click', () => {
            if (currentContextObj && currentContextObj.guest) {
                const target = currentContextObj.guest;
                
                // Gast zur√ºck in den Pool werfen
                pool.appendChild(target);
                target.classList.remove('guest-on-table');
                target.classList.add('guest-item');
                target.style.display = 'flex'; 
                
                // Aufr√§umen
                updateCounters();
                saveState();
                
                // Men√º schlie√üen
                contextMenu.style.display = 'none';
            }
        });

        // Bearbeiten
        document.getElementById('ctx-edit-name').addEventListener('click', () => {
            if (currentContextObj && currentContextObj.guest) {
                const g = currentContextObj.guest;
                const newName = prompt("Namen bearbeiten:", g.getAttribute('data-name'));
                if (newName) {
                    g.setAttribute('data-name', newName);
                    g.querySelector('.guest-name-text').innerText = newName;
                    saveState();
                }
            }
        });

        // Firma √§ndern
        document.getElementById('ctx-edit-company').addEventListener('click', () => {
            if (currentContextObj && currentContextObj.guest) {
                const g = currentContextObj.guest;
                const newComp = prompt("Firma √§ndern:", g.getAttribute('data-company'));
                if (newComp !== null) {
                    g.setAttribute('data-company', newComp);
                    let cDiv = g.querySelector('.guest-company-text');
                    if(!cDiv) { cDiv = document.createElement('div'); cDiv.className='guest-company-text'; g.appendChild(cDiv); }
                    cDiv.innerText = newComp;
                    g.className = 'guest-on-table ' + getCompanyClass(newComp);
                    saveState();
                }
            }
        });

        function updateCounters() {
            // 1. POOL SORTIEREN (Das Feature von vorhin)
            const pool = document.getElementById('guest-pool');
            const guestsInPool = Array.from(pool.getElementsByClassName('guest-item'));
            
            guestsInPool.sort((a, b) => {
                const fullA = a.getAttribute('data-name').trim();
                const fullB = b.getAttribute('data-name').trim();
                const lastA = fullA.split(' ').pop().toLowerCase();
                const lastB = fullB.split(' ').pop().toLowerCase();
                if (lastA < lastB) return -1;
                if (lastA > lastB) return 1;
                return fullA.localeCompare(fullB);
            });
            guestsInPool.forEach(guest => pool.appendChild(guest));

            // 2. DATEN SAMMELN F√úR STATISTIK
            let totalSeats = 0;
            let occupiedSeats = 0;
            
            // Neue Z√§hler
            let countAon = 0;     // Interne
            let countGuests = 0;  // Externe
            let fullTables = 0;   // Tische die voll sind
            let emptyTables = 0;  // Tische die komplett leer sind

            document.querySelectorAll('.table').forEach(table => {
                const container = table.querySelector('.seat-container');
                const counter = table.querySelector('.seat-counter');
                const max = parseInt(table.getAttribute('data-max'));
                const currentCount = container.children.length;
                
                // Generelle Z√§hler
                totalSeats += max;
                occupiedSeats += currentCount;

                // Wer sitzt hier? (Aon vs. Gast)
                const guestsOnTable = container.querySelectorAll('.guest-on-table');
                guestsOnTable.forEach(g => {
                    const comp = g.getAttribute('data-company') || "";
                    // Wir pr√ºfen, ob "aon" im Firmennamen steckt (egal ob gro√ü/klein geschrieben)
                    if (comp.toLowerCase().includes('aon')) {
                        countAon++;
                    } else {
                        countGuests++;
                    }
                });

                // Tisch Status pr√ºfen
                if (currentCount >= max) {
                    table.classList.add('table-full');
                    counter.style.color = "white"; 
                    fullTables++;
                } else {
                    table.classList.remove('table-full');
                    counter.style.color = "white";
                    if (currentCount === 0) emptyTables++;
                }

                counter.innerText = currentCount + " / " + max;
            });
            
            const free = totalSeats - occupiedSeats;

            // 3. STATISTIK HTML BAUEN
            const statsHtml = `
                <div class="stat-row">
                    <span class="stat-label">Pl√§tze belegt:</span>
                    <span class="stat-value">${occupiedSeats} / ${totalSeats}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Noch frei:</span>
                    <span class="stat-value" style="color:${free > 0 ? 'green' : 'red'}">${free}</span>
                </div>
                <div style="margin: 8px 0; border-top: 1px solid #ccc;"></div>
                <div class="stat-row">
                    <span class="stat-label">üè¢ Aon (Intern):</span>
                    <span class="stat-value">${countAon}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">üë§ G√§ste (Extern):</span>
                    <span class="stat-value">${countGuests}</span>
                </div>
                <div class="stat-sub">
                    Tische: ${fullTables} voll / ${emptyTables} leer
                </div>
            `;

            document.getElementById('stats-box').innerHTML = statsHtml;
        }

        function saveState() {
            // G√§ste speichern
            const allGuests = [];
            document.querySelectorAll('[id^="g_import_"]').forEach(el => {
                let parentId = el.parentElement.id;
                if (el.parentElement.classList.contains('seat-container')) {
                    parentId = el.parentElement.parentElement.id;
                }
                allGuests.push({
                    id: el.id, name: el.getAttribute('data-name'), 
                    company: el.getAttribute('data-company'), location: parentId
                });
            });

            // Gesperrte Tische speichern (NEU)
            const lockedTables = [];
            document.querySelectorAll('.table.locked').forEach(t => lockedTables.push(t.id));

            localStorage.setItem(STORAGE_KEY, JSON.stringify({ guests: allGuests, locked: lockedTables }));
        }

        function loadState() {
            const dataStr = localStorage.getItem(STORAGE_KEY);
            if (!dataStr) return false;
            
            let data;
            try { data = JSON.parse(dataStr); } catch(e) { return false; }

            let guests = Array.isArray(data) ? data : data.guests;
            let locked = data.locked || [];

            if (!guests || guests.length === 0) return false;

            pool.innerHTML = '';
            document.querySelectorAll('.seat-container').forEach(el => el.innerHTML = '');

            guests.forEach(g => {
                const newEl = createGuestElement(g.id.replace('g_import_', ''), g.name, g.company, false);
                let targetContainer;
                if (g.location === 'guest-pool') {
                    targetContainer = pool;
                    newEl.classList.remove('guest-on-table');
                    newEl.classList.add('guest-item');
                    newEl.style.display = 'flex';
                } else {
                    const table = document.getElementById(g.location);
                    if (table) {
                        targetContainer = table.querySelector('.seat-container');
                        newEl.classList.add('guest-on-table');
                        newEl.classList.remove('guest-item');
                        newEl.style.display = ''; 
                    }
                }
                if (targetContainer) targetContainer.appendChild(newEl);
                else pool.appendChild(newEl);
            });

            // Tische wieder sperren (NEU)
            locked.forEach(tId => {
                const t = document.getElementById(tId);
                if(t) t.classList.add('locked');
            });

            updateCounters();
            return true;
        }

        document.getElementById('reset-btn').addEventListener('click', () => {
            if(confirm('M√∂chtest du wirklich den ganzen Plan l√∂schen?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        });

        /* --- EXCEL EXPORT FUNKTION --- */
        document.getElementById('export-excel-btn').addEventListener('click', () => {
            let data = [];

            // 1. Tische sammeln und sortieren (Tisch 1, Tisch 2...)
            const tables = Array.from(document.querySelectorAll('.table'));
            tables.sort((a, b) => {
                const numA = parseInt(a.querySelector('.table-title').innerText.replace(/\D/g, ''));
                const numB = parseInt(b.querySelector('.table-title').innerText.replace(/\D/g, ''));
                return numA - numB;
            });

            // 2. Daten auslesen
            tables.forEach(table => {
                const tableName = table.querySelector('.table-title').innerText;
                const guests = table.querySelectorAll('.guest-on-table');

                guests.forEach(guest => {
                    data.push({
                        "Tisch": tableName,
                        "Name": guest.getAttribute('data-name'),
                        "Firma": guest.getAttribute('data-company') || ""
                    });
                });
            });

            if (data.length === 0) {
                alert("Es sind noch keine G√§ste platziert!");
                return;
            }

            // 3. Excel Datei erstellen und herunterladen
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Spaltenbreite automatisch anpassen (Kosmetik)
            const wscols = [{wch: 10}, {wch: 25}, {wch: 25}]; 
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sitzplan Export");

            // Datei speichern
            XLSX.writeFile(wb, "Sitzplan_Boot_Export.xlsx");
        });

        /* --- NUR TISCHE LEEREN (G√§ste zur√ºck in Pool) --- */
        const clearTablesBtn = document.getElementById('clear-tables-btn');
        
        if (clearTablesBtn) {
            clearTablesBtn.addEventListener('click', () => {
                // Sicherheitsfrage
                const isSure = confirm("M√∂chtest du alle G√§ste von den Tischen zur√ºck in die Liste legen?\n(Die Namen bleiben erhalten, nur die Zuordnung wird gel√∂scht.)");
                
                if (isSure) {
                    const pool = document.getElementById('guest-pool');
                    const allGuestsOnTables = document.querySelectorAll('.guest-on-table');
                    
                    // 1. Jeden Gast zur√ºcksetzen
                    allGuestsOnTables.forEach(guest => {
                        // In den Pool verschieben
                        pool.appendChild(guest);
                        
                        // Klassen anpassen (Tisch-Look weg, Listen-Look hin)
                        guest.classList.remove('guest-on-table');
                        guest.classList.remove('search-match-guest'); // Falls noch markiert
                        guest.classList.add('guest-item');
                        guest.style.display = 'flex'; // Sicherstellen, dass er sichtbar ist
                    });

                    // 2. Tische aufr√§umen
                    document.querySelectorAll('.table').forEach(table => {
                        table.classList.remove('table-full', 'search-match-table', 'locked'); // Auch Sperren aufheben?
                        // Falls du Sperren behalten willst, l√∂sche 'locked' oben aus der Liste
                    });

                    // 3. Alles neu berechnen & sortieren
                    updateCounters();
                    saveState();
                }
            });
        }
    </script>
</body>
</html>